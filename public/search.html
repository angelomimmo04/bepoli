<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Ricerca Utenti Live</title>
  <style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc;
    margin: 0;
    padding: 20px;
    color: #333;
  }

  h2, h3 {
    color: #2c3e50;
    margin-bottom: 10px;
  }

  input[type="text"] {
    width: 100%;
    max-width: 400px;
    padding: 12px 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: border 0.2s ease;
  }

  input[type="text"]:focus {
    border-color: #3498db;
    outline: none;
  }

  #risultati div, #recenti div {
    background-color: #fff;
    border: 1px solid #e1e4e8;
    padding: 10px 14px;
    border-radius: 10px;
    margin: 8px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: box-shadow 0.2s ease, transform 0.1s ease;
  }

  #risultati div:hover, #recenti div:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }

  img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ccc;
  }

  #risultati strong, #recenti strong {
    font-size: 16px;
    color: #2c3e50;
  }
</style>

</head>
<body>
  <h2>Cerca Utente</h2>
  <input type="text" id="searchInput" placeholder="Scrivi un username..." autocomplete="off" />
  <div id="risultati"></div>

  <h3>Visitati di recente</h3>
  <div id="recenti"></div>

  <script>
    const risultatiDiv = document.getElementById('risultati');
    const recentiDiv = document.getElementById('recenti');
    let utenteLoggato = null;

    // Recupera l'utente attualmente loggato
    fetch('/api/user', { credentials: 'include' })
      .then(res => res.json())
      .then(user => {
        utenteLoggato = user;
      });

    function salvaInCronologia(utente) {
      let recenti = JSON.parse(localStorage.getItem('utentiRecenti')) || [];
      recenti = recenti.filter(u => u.id !== utente.id);
      recenti.unshift(utente);
      if (recenti.length > 5) recenti = recenti.slice(0, 5);
      localStorage.setItem('utentiRecenti', JSON.stringify(recenti));
      mostraRecenti();
    }

    function creaDivUtente(user) {
      const div = document.createElement('div');
      div.innerHTML = `
        <img src="${user.profilePicUrl}" width="40" height="40" onerror="this.src='fotoprofilo.png'">
        <div>
          <strong>${user.username}</strong>
        </div>
      `;
      div.onclick = () => {
        salvaInCronologia(user);
        window.location.href = `/profile.html?id=${user.id}`;
      };
      return div;
    }

    function mostraRecenti() {
      recentiDiv.innerHTML = '';
      const recenti = JSON.parse(localStorage.getItem('utentiRecenti')) || [];
      recenti.forEach(user => {
        const div = creaDivUtente(user);
        recentiDiv.appendChild(div);
      });
    }

    function cercaUtente(query) {
      if (query.length < 1) {
        risultatiDiv.innerHTML = '';
        return;
      }

      fetch(`/api/search-users?q=${encodeURIComponent(query)}`, {
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        risultatiDiv.innerHTML = '';
        const utentiFiltrati = utenteLoggato
          ? data.filter(user => user.id !== utenteLoggato._id)
          : data;

        utentiFiltrati.forEach(user => {
          const div = creaDivUtente(user);
          risultatiDiv.appendChild(div);
        });
      });
    }

    let timeout = null;
    document.getElementById('searchInput').addEventListener('input', function () {
      clearTimeout(timeout);
      const query = this.value;
      timeout = setTimeout(() => cercaUtente(query), 300);
    });

    mostraRecenti();
  </script>
</body>
</html>
